<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Логозавр:)</title>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&family=Cinzel:wght@700&family=Montserrat:wght@400,700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Roboto', sans-serif;
            margin: 20px;
            background: linear-gradient(135deg, #f4f4f9, #e0e7ff);
            color: #333;
        }
        h1 {
            text-align: center;
            color: #4a90e2;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.2);
            font-family: 'Montserrat', sans-serif;
            font-size: 2.5em;
        }
        .tabs {
            display: flex;
            justify-content: center;
            margin-bottom: 20px;
        }
        .tab {
            padding: 10px 20px;
            margin: 0 5px;
            border: 2px solid #4a90e2;
            border-radius: 5px;
            background-color: #fff;
            color: #4a90e2;
            cursor: pointer;
            transition: background-color 0.3s, color 0.3s, transform 0.3s;
        }
        .tab.active {
            background-color: #4a90e2;
            color: #fff;
            box-shadow: 0 4px 10px rgba(0,0,0,0.2);
        }
        .tab-content {
            display: none;
            animation: fadeIn 0.5s ease-in-out;
        }
        .tab-content.active {
            display: block;
        }
        textarea {
            width: 100%;
            height: 200px;
            padding: 10px;
            border: 2px solid #4a90e2;
            border-radius: 5px;
            font-size: 16px;
            transition: border-color 0.3s, box-shadow 0.3s;
            box-shadow: 0px 2px 5px rgba(0,0,0,0.1);
        }
        textarea:focus {
            border-color: #357ab7;
            box-shadow: 0px 4px 10px rgba(0,0,0,0.2);
        }
        button {
            padding: 10px 20px;
            margin: 10px 5px;
            border: none;
            border-radius: 5px;
            background-color: #4a90e2;
            color: white;
            font-size: 16px;
            cursor: pointer;
            transition: background-color 0.3s, transform 0.3s, box-shadow 0.3s;
            box-shadow: 0px 2px 5px rgba(0,0,0,0.1);
        }
        button:hover {
            background-color: #357ab7;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
        }
        button:active {
            transform: scale(0.95);
            box-shadow: 0px 2px 5px rgba(0,0,0,0.2) inset;
        }
        #results {
            margin-top: 20px;
            padding: 20px;
            background-color: #fff;
            border: 2px solid #4a90e2;
            border-radius: 5px;
            box-shadow: 0 0 10px rgba(0,0,0,0.1);
            animation: fadeIn 1s ease-in-out;
            font-family: 'Cinzel', serif;
        }
        ul {
            list-style-type: none;
            padding: 0;
        }
        li {
            padding: 5px 0;
            font-size: 18px;
            display: flex;
            align-items: center;
            font-weight: bold;
        }
        .results-column {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 10px;
        }
        .results-column div {
            padding: 10px;
            border: 2px solid #4a90e2;
            border-radius: 5px;
            background-color: #fff;
            width: 100%;
            text-align: center;
            box-shadow: 0 0 10px rgba(0,0,0,0.1);
            animation: slideIn 0.5s ease-in-out;
        }
        .monster-image {
            width: 50px;
            height: 50px;
            margin-right: 10px;
            border-radius: 5px;
            box-shadow: 0px 2px 5px rgba(0,0,0,0.2);
        }
        .coin {
            width: 20px;
            height: 20px;
            vertical-align: middle;
        }
        .item-image {
            width: 50px;
            height: 50px;
            vertical-align: middle;
            margin-right: 10px;
        }
        .checkbox-group {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-bottom: 10px;
        }
        .checkbox-group label {
            display: flex;
            align-items: center;
            gap: 5px;
        }
        .checkbox-group input {
            margin: 0;
        }
        .add-item {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 10px;
        }
        .add-item input {
            padding: 10px;
            border: 2px solid #4a90e2;
            border-radius: 5px;
            font-size: 16px;
        }
        .spoiler {
            margin: 10px 0;
        }
        .spoiler-content {
            display: none;
            padding: 10px;
            border: 2px solid #4a90e2;
            border-radius: 5px;
            background-color: #fff;
        }
        .spoiler-button {
            background-color: #4a90e2;
            color: white;
            padding: 10px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            transition: background-color 0.3s, transform 0.3s, box-shadow 0.3s;
            box-shadow: 0px 2px 5px rgba(0,0,0,0.1);
        }
        .spoiler-button:hover {
            background-color: #357ab7;
            transform: scale(1.05);
        }
        .spoiler-button:active {
            transform: scale(0.95);
            box-shadow: 0px 2px 5px rgba(0,0,0,0.2) inset;
        }
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        @keyframes slideIn {
            from { transform: translateY(20px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        /* Стили для вкладки "Рекорды" и "Статистика" */
        .records-container, .stats-container {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
        }
        .records-section, .stats-section {
            flex: 1;
            min-width: 300px;
            background-color: #f5f5f5;
            border-radius: 5px;
            padding: 15px;
            box-shadow: 0px 2px 5px rgba(0,0,0,0.1);
        }
        .record-item {
            display: flex;
            align-items: center;
            margin-bottom: 10px;
            padding: 10px;
            background-color: white;
            border-radius: 5px;
            box-shadow: 0px 1px 3px rgba(0,0,0,0.1);
        }
        .record-info {
            flex-grow: 1;
        }
        .record-date {
            color: #777;
            font-size: 0.8em;
        }
        
        /* Стили для вкладки "История" */
        .history-day {
            margin-bottom: 15px;
        }
        .history-date {
            font-weight: bold;
            cursor: pointer;
            padding: 10px;
            background-color: #f5f5f5;
            border-radius: 5px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .history-date:hover {
            background-color: #e9e9e9;
        }
        .history-entries {
            display: none;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 0 0 5px 5px;
            margin-top: -5px;
            background-color: white;
        }
        .history-entry {
            margin-bottom: 10px;
            padding: 10px;
            border-bottom: 1px solid #eee;
        }
        .history-time {
            font-size: 0.9em;
            color: #666;
        }
        .history-type {
            font-weight: bold;
            margin-right: 10px;
        }
        
        /* Стили для таблиц статистики */
        .stats-table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 15px;
        }
        .stats-table th, .stats-table td {
            padding: 8px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }
        .stats-table th {
            background-color: #f2f2f2;
            font-weight: bold;
        }
        .stats-table tr:hover {
            background-color: #f5f5f5;
        }
        .money-stats {
            display: flex;
            align-items: center;
            gap: 5px;
            margin: 15px 0;
            font-size: 1.2em;
        }
        
        @media (max-width: 600px) {
            h1 {
                font-size: 1.5em;
            }
            button {
                width: 100%;
            }
            .records-container {
                flex-direction: column;
            }
        }
        
        .record-item button {
            margin-left: 5px;
            padding: 5px;
            border: none;
            border-radius: 5px;
            background-color: transparent;
            color: #4a90e2;
            cursor: pointer;
            font-size: 18px; /* Размер шрифта для иконок */
            transition: color 0.3s;
        }

        .record-item button:hover {
            color: #357ab7;
        }
    </style>
</head>
<body>
    <h1>Логозавр:)</h1>
    <div class="tabs">
        <div class="tab active" onclick="showTab('log')">Лог</div>
        <div class="tab" onclick="showTab('attacks')">Нападения</div>
        <div class="tab" onclick="showTab('money')">Деньги</div>
        <div class="tab" onclick="showTab('items')">Предметы</div>
        <div class="tab" onclick="showTab('junk')">Хлам</div>
        <div class="tab" onclick="showTab('records')">Рекорды</div>
        <div class="tab" onclick="showTab('history')">История</div>
        <div class="tab" onclick="showTab('stats')">Статистика</div>
    </div>
    <div id="log" class="tab-content active">
        <textarea id="logInput" placeholder="Введите лог здесь..."></textarea>
    </div>
    <div id="attacks" class="tab-content">
        <button onclick="countAttacks()">Посчитать нападения</button>
    </div>
    <div id="money" class="tab-content">
        <button onclick="countMoney()">Посчитать деньги</button>
    </div>
    <div id="items" class="tab-content">
        <button class="spoiler-button" onclick="toggleSpoiler('itemFilter')">Показать/Скрыть фильтр предметов</button>
        <div id="itemFilter" class="spoiler-content">
            <div class="checkbox-group" id="itemCheckboxGroup">
                <!-- Существующие предметы будут добавлены здесь -->
            </div>
            <div class="add-item">
                <input type="text" id="newItemInput" placeholder="Введите название предмета">
                <button onclick="addItem()">Добавить предмет</button>
                <button onclick="clearStorage()">Очистить хранилище</button>
                <input type="file" id="fileInput" accept=".txt" onchange="importItems(event)">
            </div>
            <button onclick="toggleSelectAll()">Выбрать все/Снять все</button>
            <button onclick="removeSelectedItems()">Удалить выбранные</button> <!-- Новая кнопка -->
        </div>
        <button onclick="countItems()">Посчитать предметы</button>
    </div>
    <div id="junk" class="tab-content">
        <h2>Управление хламом</h2>
        <div class="add-item">
            <input type="text" id="junkItemName" placeholder="Название предмета хлама">
            <div class="money-input">
                <input type="number" id="junkGoldValue" placeholder="Золото" min="0" value="0" style="width: 80px">
                <input type="number" id="junkSilverValue" placeholder="Серебро" min="0" value="0" style="width: 80px">
                <input type="number" id="junkCopperValue" placeholder="Медь" min="0" value="0" style="width: 80px">
            </div>
            <button onclick="addJunkItem()">Добавить предмет хлама</button>
        </div>
        
        <h3>Список предметов хлама</h3>
        <div id="junkItems" class="items-list">
            <!-- Здесь будут отображаться предметы хлама -->
        </div>
        
        <button onclick="clearJunkItems()">Очистить все предметы хлама</button>
        <button onclick="countJunkItems()">Посчитать предметы хлама</button>
    </div>
    <div id="records" class="tab-content">
        <h2>Рекорды</h2>
        <div class="records-container">
            <div class="records-section">
                <h3>Рекорды нападений</h3>
                <div id="attack-records"></div>
                <button onclick="clearRecords('attack-records')">Сбросить рекорды нападений</button>
            </div>
            <div class="records-section">
                <h3>Рекорды денег</h3>
                <div id="money-records"></div>
                <button onclick="clearRecords('money-record')">Сбросить рекорды денег</button>
            </div>
        </div>
    </div>
    <div id="history" class="tab-content">
        <h2>История измерений</h2>
        <div id="history-container">
            <!-- История будет добавлена здесь -->
        </div>
        <button onclick="clearHistory()">Очистить историю</button>
    </div>
    <div id="stats" class="tab-content">
        <h2>Общая статистика</h2>
        <div class="stats-container">
            <div class="stats-section">
                <h3>Монстры</h3>
                <div id="total-monsters-stats"></div>
            </div>
            <div class="stats-section">
                <h3>Деньги</h3>
                <div id="total-money-stats"></div>
            </div>
            <div class="stats-section">
                <h3>Предметы</h3>
                <div id="total-items-stats"></div>
            </div>
        </div>
    </div>
    <div id="results">
        <h2>Результаты будут отображаться здесь</h2>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            loadSettings();
            displayAttackRecords();
            displayMoneyRecords();
            loadHistory();
            loadStats();
            loadJunkItems(); // Загружаем предметы хлама при загрузке страницы
            
            // Обработчик двойного клика на записи истории
            document.getElementById('history-container').addEventListener('dblclick', function(event) {
                handleHistoryEntryDblClick(event);
            });
        });

        function showTab(tabId) {
            const tabs = document.querySelectorAll('.tab');
            const tabContents = document.querySelectorAll('.tab-content');
            
            // Удаляем класс active со всех вкладок и содержимого
            tabs.forEach(tab => tab.classList.remove('active'));
            tabContents.forEach(content => content.classList.remove('active'));
            
            // Находим индекс вкладки по порядку (Лог, Нападения, Деньги, Предметы, Хлам и т.д.)
            const tabIndex = ['log', 'attacks', 'money', 'items', 'junk', 'records', 'history', 'stats'].indexOf(tabId);
            
            if (tabIndex !== -1) {
                // Устанавливаем active для соответствующей вкладки
                const activeTab = document.querySelector(`.tab:nth-child(${tabIndex + 1})`);
                if (activeTab) {
                    activeTab.classList.add('active');
                }
                
                // Устанавливаем active для соответствующего содержимого
                const activeContent = document.getElementById(tabId);
                if (activeContent) {
                    activeContent.classList.add('active');
                }
            }
            
            // Если выбрана вкладка "Хлам", загрузим список предметов хлама
            if (tabId === 'junk') {
                loadJunkItems();
            }
        }

        function toggleSpoiler(id) {
            const content = document.getElementById(id);
            if (content.style.display === 'block') {
                content.style.display = 'none';
            } else {
                content.style.display = 'block';
            }
        }

        function countAttacks() {
            const logInput = document.getElementById('logInput').value;
            
            // Правило для подсчета нападений
            const attackCounts = parseLog(logInput, /Вы совершили нападение на (.+?)\s*\[/g);
            displayResults(attackCounts, 'Результаты нападений:', true);
        }

        function countMoney() {
            let logInput = document.getElementById('logInput').value;
            
            // Добавим строки с хламом из сохраненных предметов хлама в лог
            const junkLogLines = generateJunkLogLines();
            if (junkLogLines) {
                logInput += '\n' + junkLogLines;
                // Обновляем текстовое поле, чтобы пользователь видел добавленные строки
                document.getElementById('logInput').value = logInput;
            }
            
            const logLines = logInput.split('\n');
            
            // Регулярное выражение для обычных денег (с тремя числами - золото, серебро, медь)
            const goldSilverCopperPattern = /Вы получили:\s*(\d+)\s+(\d+)\s+(\d+)/;
            
            // Регулярное выражение для обычных денег (с двумя числами - серебро, медь)
            const silverCopperPattern = /Вы получили:\s*(\d+)\s+(\d+)(?!\s+\d)/;
            
            // Регулярное выражение для магических денег (с тремя числами - золото, серебро, медь)
            const magicGoldSilverCopperPattern = /Благодаря магическим эффектам, вы сумели обогатиться еще на\s*(\d+)\s+(\d+)\s+(\d+)/;
            
            // Регулярное выражение для магических денег (с двумя числами - серебро, медь)
            const magicSilverCopperPattern = /Благодаря магическим эффектам, вы сумели обогатиться еще на\s*(\d+)\s+(\d+)(?!\s+\d)/;
            
            // Регулярное выражение для хлама (с тремя числами - золото, серебро, медь)
            const junkGoldSilverCopperPattern = /Хлам принес вам:\s*(\d+)\s+(\d+)\s+(\d+)/;
            
            // Регулярное выражение для хлама (с двумя числами - серебро, медь)
            const junkSilverCopperPattern = /Хлам принес вам:\s*(\d+)\s+(\d+)(?!\s+\d)/;
            
            // Подсчет обычных денег
            const totalCopperGSC = calculateTotalCopper(logLines, goldSilverCopperPattern, true);
            const totalCopperSC = calculateTotalCopper(logLines, silverCopperPattern, false);
            const totalCopper = totalCopperGSC + totalCopperSC;
            
            // Подсчет магических денег
            const magicTotalCopperGSC = calculateTotalCopper(logLines, magicGoldSilverCopperPattern, true);
            const magicTotalCopperSC = calculateTotalCopper(logLines, magicSilverCopperPattern, false);
            const magicTotalCopper = magicTotalCopperGSC + magicTotalCopperSC;
            
            // Подсчет денег с хлама
            const junkTotalCopperGSC = calculateTotalCopper(logLines, junkGoldSilverCopperPattern, true);
            const junkTotalCopperSC = calculateTotalCopper(logLines, junkSilverCopperPattern, false);
            
            // Подсчет денег с предметов хлама найденных в логе
            const junkItemsCopper = calculateJunkItemsFromLog(logLines);
            
            const junkTotalCopper = junkTotalCopperGSC + junkTotalCopperSC + junkItemsCopper;
            
            const combinedTotalCopper = totalCopper + magicTotalCopper + junkTotalCopper;

            const moneyResult = formatMoneyResult(totalCopper, 'Выбито с боев') +
                               formatMoneyResult(magicTotalCopper, 'Благодаря магическим эффектам') +
                               formatMoneyResult(junkTotalCopper, 'Хлам') +
                               formatMoneyResult(combinedTotalCopper, 'Итого');

            displayMoneyResults(moneyResult, 'Результаты подсчета денег:');
        }
        
        // Функция для подсчета стоимости предметов хлама, найденных в логе
        function calculateJunkItemsFromLog(logLines) {
            // Получаем список предметов хлама
            const junkItems = JSON.parse(localStorage.getItem('junkItems')) || [];
            if (junkItems.length === 0) {
                return 0;
            }
            
            let totalCopper = 0;
            
            // Для каждого предмета хлама проверяем, сколько раз он встречается в логе
            junkItems.forEach(item => {
                const itemName = item.name.trim();
                if (!itemName) return;
                
                // Экранируем специальные символы в названии предмета
                const escapedItemName = itemName.replace(/[-\/\\^$*+?.()|[\]{}]/g, '\\$&');
                
                // Создаем регулярные выражения для поиска предмета в логе
                // Формат: "Вы получили: Предмет хлама X шт"
                const itemRegex1 = new RegExp(`Вы получили:\\s*${escapedItemName}\\s+(\\d+)\\s+шт`, 'gi');
                // Формат: "Получено: Предмет хлама X шт"
                const itemRegex2 = new RegExp(`Получено:\\s*${escapedItemName}\\s+(\\d+)\\s+шт`, 'gi');
                // Формат: "XX:XX Получено: Предмет хлама X шт"
                const itemRegex3 = new RegExp(`\\d+:\\d+\\s+Получено:\\s*${escapedItemName}\\s+(\\d+)\\s+шт`, 'gi');
                // Формат просто упоминание предмета в логе
                const itemRegex4 = new RegExp(`${escapedItemName}`, 'gi');
                // Формат "[предмет] X шт"
                const itemRegex5 = new RegExp(`${escapedItemName}\\s+(\\d+)\\s+шт`, 'gi');
                
                // Специальный формат для "Злое око"
                const itemRegex6 = new RegExp(`Злое\\s+око`, 'gi');
                
                let itemCount = 0;
                
                // Подсчитываем количество предметов в логе
                logLines.forEach(line => {
                    let match;
                    
                    // Проверяем первый формат
                    while ((match = itemRegex1.exec(line)) !== null) {
                        const count = parseInt(match[1]) || 1;
                        itemCount += count;
                    }
                    
                    // Проверяем второй формат
                    itemRegex2.lastIndex = 0; // Сбрасываем индекс поиска
                    while ((match = itemRegex2.exec(line)) !== null) {
                        const count = parseInt(match[1]) || 1;
                        itemCount += count;
                    }
                    
                    // Проверяем третий формат
                    itemRegex3.lastIndex = 0; // Сбрасываем индекс поиска
                    while ((match = itemRegex3.exec(line)) !== null) {
                        const count = parseInt(match[1]) || 1;
                        itemCount += count;
                    }
                    
                    // Если не нашли по форматам, проверяем просто упоминание предмета
                    if (itemCount === 0) {
                        itemRegex4.lastIndex = 0; // Сбрасываем индекс поиска
                        if (itemRegex4.test(line)) {
                            itemCount += 1;
                        }
                        
                        // Проверяем формат "[предмет] X шт"
                        itemRegex5.lastIndex = 0; // Сбрасываем индекс поиска
                        while ((match = itemRegex5.exec(line)) !== null) {
                            const count = parseInt(match[1]) || 1;
                            itemCount += count;
                        }
                        
                        // Проверяем специальное регулярное выражение для "Злое око"
                        if (item.name === "Злое око") {
                            itemRegex6.lastIndex = 0; // Сбрасываем индекс поиска
                            if (itemRegex6.test(line)) {
                                // Пытаемся найти формат "Злое око X шт"
                                const shtukaMatch = line.match(/Злое\s+око\s+(\d+)\s+шт/i);
                                if (shtukaMatch && shtukaMatch[1]) {
                                    const count = parseInt(shtukaMatch[1]) || 1;
                                    itemCount += count;
                                } else {
                                    // Если формат не "X шт", то просто +1
                                    itemCount += 1;
                                }
                            }
                        }
                    }
                });
                
                // Если предмет найден в логе, добавляем его стоимость к общей сумме
                if (itemCount > 0) {
                    const gold = parseInt(item.goldValue) || 0;
                    const silver = parseInt(item.silverValue) || 0;
                    const copper = parseInt(item.copperValue) || 0;
                    
                    // Правильно считаем стоимость, умножая каждую часть отдельно
                    totalCopper += (gold * 10000 + silver * 100 + copper) * itemCount; // золото в медь
                    
                    console.log(`Найден предмет хлама в логе: ${item.name} - ${itemCount} шт., стоимость: (${gold}з ${silver}с ${copper}м) за штуку, общая стоимость: ${gold * itemCount}з ${silver * itemCount}с ${copper * itemCount}м`);
                }
            });
            
            return totalCopper;
        }

        function countItems() {
            const logInput = document.getElementById('logInput').value;
            const selectedItems = Array.from(document.querySelectorAll('.item-checkbox:checked')).map(checkbox => checkbox.value);
            
            if (selectedItems.length === 0) {
                alert('Выберите хотя бы один предмет для поиска.');
                return;
            }
            
            // Создаем счетчик для хранения результатов
            const itemCounts = {};
            
            // Разбиваем лог на строки
            const logLines = logInput.split('\n');
            
            // Перебираем строки лога
            logLines.forEach(line => {
                // Для каждого выбранного предмета проверяем, есть ли он в строке
                selectedItems.forEach(item => {
                    // Экранируем специальные символы в названии предмета
                    const escapedItem = item.replace(/[-\/\\^$*+?.()|[\]{}]/g, '\\$&');
                    
                    // Создаем регулярное выражение для конкретного предмета
                    const itemRegex = new RegExp(`${escapedItem}\\s+(\\d+)\\s+шт`, 'g');
                    
                    // Поиск предмета в строке
                    let match;
                    while ((match = itemRegex.exec(line)) !== null) {
                        // Извлекаем количество
                        const quantity = parseInt(match[1]) || 1;
                        
                        // Добавляем к общему счету
                        itemCounts[item] = (itemCounts[item] || 0) + quantity;
                    }
                });
            });
            
            displayResults(itemCounts, 'Результаты подсчета предметов:', true);
        }

        function toggleSelectAll() {
            const checkboxes = document.querySelectorAll('.item-checkbox');
            const allChecked = Array.from(checkboxes).every(checkbox => checkbox.checked);
            checkboxes.forEach(checkbox => checkbox.checked = !allChecked);
        }

        function clearStorage() {
            localStorage.removeItem('itemSettings');
            document.getElementById('itemCheckboxGroup').innerHTML = '';
            alert('Локальное хранилище очищено.');
        }

        function addItem() {
            const newItemInput = document.getElementById('newItemInput');
            const newItem = newItemInput.value.trim();
            if (newItem && !isItemExists(newItem.toLowerCase())) {
                const checkboxGroup = document.getElementById('itemCheckboxGroup');
                const label = document.createElement('label');
                label.innerHTML = `<input type="checkbox" class="item-checkbox" value="${newItem}"> ${newItem}`;
                checkboxGroup.appendChild(label);
                newItemInput.value = '';
                saveSettings();
            } else {
                alert('Этот предмет уже существует или поле пустое.');
            }
        }

        function removeSelectedItems() {
            const checkboxes = document.querySelectorAll('.item-checkbox:checked');
            checkboxes.forEach(checkbox => {
                const label = checkbox.parentElement;
                label.remove();
            });
            saveSettings();
        }

        function isItemExists(item) {
            const checkboxes = document.querySelectorAll('.item-checkbox');
            return Array.from(checkboxes).some(checkbox => checkbox.value.toLowerCase() === item);
        }

        function importItems(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                const content = e.target.result;
                const lines = content.split('\n');
                const checkboxGroup = document.getElementById('itemCheckboxGroup');
                
                lines.forEach(line => {
                    const item = line.trim();
                    if (item && !isItemExists(item.toLowerCase())) {
                        const label = document.createElement('label');
                        label.innerHTML = `<input type="checkbox" class="item-checkbox" value="${item}"> ${item}`;
                        checkboxGroup.appendChild(label);
                    }
                });
                
                saveSettings();
                event.target.value = '';
            };
            reader.readAsText(file);
        }

        function saveSettings() {
            const checkboxes = document.querySelectorAll('.item-checkbox');
            const items = Array.from(checkboxes).map(checkbox => checkbox.value);
            localStorage.setItem('itemSettings', JSON.stringify(items));
        }

                function loadSettings() {
            try {
                const savedItems = JSON.parse(localStorage.getItem('itemSettings')) || [];
                const checkboxGroup = document.getElementById('itemCheckboxGroup');
                
                savedItems.forEach(item => {
                    const label = document.createElement('label');
                    label.innerHTML = `<input type="checkbox" class="item-checkbox" value="${item}"> ${item}`;
                    checkboxGroup.appendChild(label);
                });
            } catch (error) {
                console.error('Error loading settings:', error);
                localStorage.removeItem('itemSettings');
            }
        }

        function parseLog(log, pattern) {
            const counts = {};
            let match;
            
            if (pattern.global) {
                // For global regex patterns
                while ((match = pattern.exec(log)) !== null) {
                    const name = match[1].trim();
                    const quantity = match[2] ? parseInt(match[2]) : 1;
                    counts[name] = (counts[name] || 0) + quantity;
                }
            } else {
                // For non-global regex patterns
                const lines = log.split('\n');
                for (const line of lines) {
                    match = line.match(pattern);
                    if (match) {
                        const name = match[1].trim();
                        const quantity = match[2] ? parseInt(match[2]) : 1;
                        counts[name] = (counts[name] || 0) + quantity;
                    }
                }
            }
            
            return counts;
        }

        function calculateTotalCopper(logLines, pattern, hasGold = false) {
            let totalCopper = 0;
            
            for (const line of logLines) {
                const match = line.match(pattern);
                if (match) {
                    if (hasGold) {
                        // Если это формат с золотом, серебром и медью
                        const gold = parseInt(match[1]) || 0;
                        const silver = parseInt(match[2]) || 0;
                        const copper = parseInt(match[3]) || 0;
                        
                        totalCopper += gold * 10000 + silver * 100 + copper;
                    } else {
                        // Если это формат только с серебром и медью
                        const silver = parseInt(match[1]) || 0;
                        const copper = parseInt(match[2]) || 0;
                        
                        totalCopper += silver * 100 + copper;
                    }
                }
            }
            
            return totalCopper;
        }

        function formatMoneyResult(totalCopper, label) {
            const gold = Math.floor(totalCopper / 10000);
            const remainder = totalCopper % 10000;
            const silver = Math.floor(remainder / 100);
            const copper = remainder % 100;

            return `<div>${label}: ${gold} <img src="images/gold_coin.png" class="coin" alt="золото">, ${silver} <img src="images/silver_coin.png" class="coin" alt="серебро">, ${copper} <img src="images/copper_coin.png" class="coin" alt="медь"></div>`;
        }

        function displayMoneyResults(results, title) {
            const resultsDiv = document.getElementById('results');
            resultsDiv.innerHTML = `<h2>${title}</h2>`;
            const div = document.createElement('div');
            div.className = 'results-column';
            div.innerHTML = results;
            resultsDiv.appendChild(div);
            
            // Обновление рекордов денег и истории
            updateMoneyRecords(results);
            addHistoryEntry('money', results);
        }

        function displayResults(results, title, includeImages = false) {
            const resultsDiv = document.getElementById('results');
            resultsDiv.innerHTML = `<h2>${title}</h2>`;
            const container = document.createElement('div');
            container.style.display = 'flex';
            container.style.flexWrap = 'wrap';
            
            let totalCount = 0;
            // Вычисляем общее количество для процентов
            for (const value of Object.values(results)) {
                totalCount += parseInt(value);
            }
            
            let row = document.createElement('div');
            row.style.display = 'flex';
            row.style.width = '100%';

            let count = 0;

            for (const [key, value] of Object.entries(results)) {
                const itemDiv = document.createElement('div');
                itemDiv.style.flex = '1 0 30%'; // Занимает 30% ширины, чтобы вмещать 3 предмета в строке
                itemDiv.style.boxSizing = 'border-box';
                itemDiv.style.padding = '10px'; // Отступы для визуального разделения
                
                // Вычисляем процент и создаем прогресс-бар
                const percent = totalCount > 0 ? Math.round((value / totalCount) * 100) : 0;
                
                // Добавляем информацию с процентами и прогресс-баром
                itemDiv.innerHTML = `
                    ${includeImages ? `<img src="images/${key}.gif" class="item-image" alt="${key}">` : ''} 
                    <div>${key}: ${value} (${percent}%)</div>
                    <div class="progress-bar-container">
                        <div class="progress-bar" style="width: ${percent}%;"></div>
                    </div>
                `;
                
                row.appendChild(itemDiv);
                count++;

                // Если добавлено 3 предмета, добавляем строку в контейнер и создаем новую
                if (count % 3 === 0) {
                    container.appendChild(row);
                    row = document.createElement('div');
                    row.style.display = 'flex';
                    row.style.width = '100%';
                }
            }

            // Добавляем оставшиеся элементы, если они есть
            if (count % 3 !== 0) {
                container.appendChild(row);
            }

            resultsDiv.appendChild(container);
            
            // Если это результаты нападений, обновляем рекорды
            if (title === 'Результаты нападений:') {
                updateAttackRecords(results);
                addHistoryEntry('attacks', results);
            } else if (title === 'Результаты подсчета предметов:') {
                addHistoryEntry('items', results);
            }
        }
        
        // Функция для обновления рекордов нападений
        function updateAttackRecords(results) {
            // Загрузка текущих рекордов
            const records = JSON.parse(localStorage.getItem('attack-records') || '{}');
            let updated = false;
            
            // Проверка и обновление рекордов
            for (const [monster, count] of Object.entries(results)) {
                if (!records[monster] || records[monster].count < count) {
                    records[monster] = {
                        count: count,
                        date: new Date().toISOString()
                    };
                    updated = true;
                }
            }
            
            // Сохранение рекордов и обновление отображения
            if (updated) {
                localStorage.setItem('attack-records', JSON.stringify(records));
                displayAttackRecords();
            }
        }
        
        // Функция для обновления рекордов денег
        function updateMoneyRecords(resultHTML) {
            // Извлечение итогового значения меди из HTML
            const totalMatch = resultHTML.match(/Итого: (\d+) .+?, (\d+) .+?, (\d+)/);
            if (!totalMatch) return;
            
            const gold = parseInt(totalMatch[1]);
            const silver = parseInt(totalMatch[2]);
            const copper = parseInt(totalMatch[3]);
            
            // Рассчитываем общее количество меди
            const totalCopper = gold * 10000 + silver * 100 + copper;
            
            // Загрузка текущего рекорда
            const record = JSON.parse(localStorage.getItem('money-record') || '{"totalCopper": 0}');
            
            // Проверка, является ли текущий результат новым рекордом
            if (totalCopper > record.totalCopper) {
                const newRecord = {
                    totalCopper: totalCopper,
                    gold: gold,
                    silver: silver,
                    copper: copper,
                    date: new Date().toISOString()
                };
                
                localStorage.setItem('money-record', JSON.stringify(newRecord));
                displayMoneyRecords();
            }
        }
        
        // Функция для отображения рекордов нападений
        function displayAttackRecords() {
            const recordsContainer = document.getElementById('attack-records');
            recordsContainer.innerHTML = '';
            
            const records = JSON.parse(localStorage.getItem('attack-records') || '{}');
            
            if (Object.keys(records).length === 0) {
                recordsContainer.innerHTML = '<p>Нет рекордов</p>';
                return;
            }
            
            for (const [monster, record] of Object.entries(records)) {
                const recordItem = document.createElement('div');
                recordItem.className = 'record-item';
                
                // Информация о рекорде
                const info = document.createElement('div');
                info.className = 'record-info';
                info.innerHTML = `<div>${monster}: ${record.count}</div>`;
                
                if (record.date) {
                    const date = document.createElement('div');
                    date.className = 'record-date';
                    date.textContent = new Date(record.date).toLocaleDateString();
                    info.appendChild(date);
                }
                
                recordItem.appendChild(info);
                
                // Кнопки редактирования и удаления
                const editButton = document.createElement('button');
                editButton.innerHTML = '&#9998;'; // Иконка ручки
                editButton.title = 'Редактировать';
                editButton.onclick = () => editRecord('attack-records', monster);
                recordItem.appendChild(editButton);
                
                const deleteButton = document.createElement('button');
                deleteButton.innerHTML = '&#10006;'; // Иконка крестика
                deleteButton.title = 'Удалить';
                deleteButton.onclick = () => deleteRecord('attack-records', monster);
                recordItem.appendChild(deleteButton);
                
                recordsContainer.appendChild(recordItem);
            }
        }
        
        // Функция для отображения рекордов денег
        function displayMoneyRecords() {
            const recordsContainer = document.getElementById('money-records');
            recordsContainer.innerHTML = '';
            
            const record = JSON.parse(localStorage.getItem('money-record') || '{"totalCopper": 0}');
            
            if (record.totalCopper === 0) {
                recordsContainer.innerHTML = '<p>Нет рекордов</p>';
                return;
            }
            
            const recordItem = document.createElement('div');
            recordItem.className = 'record-item';
            
            // Информация о рекорде
            const info = document.createElement('div');
            info.className = 'record-info';
            
            const moneyAmount = document.createElement('div');
            moneyAmount.innerHTML = `Рекорд: ${record.gold || 0} <img src="images/gold_coin.png" class="coin" alt="золото">, 
                                     ${record.silver || 0} <img src="images/silver_coin.png" class="coin" alt="серебро">, 
                                     ${record.copper || 0} <img src="images/copper_coin.png" class="coin" alt="медь">`;
            info.appendChild(moneyAmount);
            
            if (record.date) {
                const date = document.createElement('div');
                date.className = 'record-date';
                date.textContent = new Date(record.date).toLocaleDateString();
                info.appendChild(date);
            }
            
            recordItem.appendChild(info);
            
            // Кнопки редактирования и удаления
            const editButton = document.createElement('button');
            editButton.innerHTML = '&#9998;'; // Иконка ручки
            editButton.title = 'Редактировать';
            editButton.onclick = () => editMoneyRecord();
            recordItem.appendChild(editButton);
            
            const deleteButton = document.createElement('button');
            deleteButton.innerHTML = '&#10006;'; // Иконка крестика
            deleteButton.title = 'Удалить';
            deleteButton.onclick = () => deleteMoneyRecord();
            recordItem.appendChild(deleteButton);
            
            recordsContainer.appendChild(recordItem);
        }
        
        // Функция для удаления рекорда нападений
        function deleteRecord(recordType, monster) {
            if (confirm(`Вы уверены, что хотите удалить рекорд для ${monster}?`)) {
                const records = JSON.parse(localStorage.getItem(recordType) || '{}');
                delete records[monster];
                localStorage.setItem(recordType, JSON.stringify(records));
                displayAttackRecords(); // Обновляем отображение
            }
        }

        // Функция для удаления рекорда денег
        function deleteMoneyRecord() {
            if (confirm('Вы уверены, что хотите удалить рекорд денег?')) {
                localStorage.removeItem('money-record');
                displayMoneyRecords(); // Обновляем отображение
            }
        }

        // Функция для редактирования рекорда нападений
        function editRecord(recordType, monster) {
            const records = JSON.parse(localStorage.getItem(recordType) || '{}');
            const newCount = prompt(`Введите новое количество для ${monster}:`, records[monster].count);
            
            if (newCount !== null) {
                records[monster].count = parseInt(newCount);
                records[monster].date = new Date().toISOString(); // Обновляем дату
                localStorage.setItem(recordType, JSON.stringify(records));
                displayAttackRecords(); // Обновляем отображение
            }
        }

        // Функция для редактирования рекорда денег
        function editMoneyRecord() {
            const record = JSON.parse(localStorage.getItem('money-record') || '{"totalCopper": 0}');
            const newGold = prompt(`Введите новое количество золота:`, record.gold);
            const newSilver = prompt(`Введите новое количество серебра:`, record.silver);
            const newCopper = prompt(`Введите новое количество меди:`, record.copper);
            
            if (newGold !== null && newSilver !== null && newCopper !== null) {
                record.gold = parseInt(newGold);
                record.silver = parseInt(newSilver);
                record.copper = parseInt(newCopper);
                record.totalCopper = record.gold * 10000 + record.silver * 100 + record.copper;
                record.date = new Date().toISOString(); // Обновляем дату
                
                localStorage.setItem('money-record', JSON.stringify(record));
                displayMoneyRecords(); // Обновляем отображение
            }
        }

        // Функция для очистки рекордов
        function clearRecords(recordType) {
            if (confirm('Вы уверены, что хотите сбросить все рекорды?')) {
                localStorage.removeItem(recordType);
                if (recordType === 'attack-records') {
                    displayAttackRecords();
                } else {
                    displayMoneyRecords();
                }
            }
        }
        
        // Функция для добавления записи в историю
        function addHistoryEntry(type, data) {
            // Загрузка текущей истории
            const history = JSON.parse(localStorage.getItem('log-history') || '[]');
            
            // Создание новой записи
            const entry = {
                type: type,
                date: new Date().toISOString(),
                data: data // Данные зависят от типа (результаты нападений, денег или предметов)
            };
            
            // Добавление записи в начало истории
            history.unshift(entry);
            
            // Ограничение истории до 100 записей
            if (history.length > 100) {
                history.pop();
            }
            
            // Сохранение истории
            localStorage.setItem('log-history', JSON.stringify(history));
            
            // Обновление отображения истории
            displayHistory();
        }
        
        // Функция для отображения истории
        function displayHistory() {
            const historyContainer = document.getElementById('history-container');
            historyContainer.innerHTML = '';
            
            // Загрузка истории
            const history = JSON.parse(localStorage.getItem('log-history') || '[]');
            
            if (history.length === 0) {
                historyContainer.innerHTML = '<p>История пуста</p>';
                return;
            }
            
            // Группировка записей по датам
            const groupedHistory = {};
            
            history.forEach(entry => {
                const date = new Date(entry.date).toLocaleDateString();
                if (!groupedHistory[date]) {
                    groupedHistory[date] = [];
                }
                groupedHistory[date].push(entry);
            });
            
            // Отображение сгруппированной истории
            for (const [date, entries] of Object.entries(groupedHistory)) {
                const historyDay = document.createElement('div');
                historyDay.className = 'history-day';
                
                // Дата и количество записей
                const dateHeader = document.createElement('div');
                dateHeader.className = 'history-date';
                dateHeader.textContent = `${date} (${entries.length})`;
                dateHeader.onclick = function() {
                    const entriesDiv = this.nextElementSibling;
                    entriesDiv.style.display = entriesDiv.style.display === 'none' || entriesDiv.style.display === '' ? 'block' : 'none';
                };
                historyDay.appendChild(dateHeader);
                
                // Контейнер для записей за день
                const entriesDiv = document.createElement('div');
                entriesDiv.className = 'history-entries';
                
                // Добавление каждой записи
                entries.forEach(entry => {
                    const entryDiv = document.createElement('div');
                    entryDiv.className = 'history-entry';
                    
                    // Время и тип
                    const timeAndType = document.createElement('div');
                    const time = new Date(entry.date).toLocaleTimeString();
                    timeAndType.innerHTML = `<span class="history-time">${time}</span> <span class="history-type">${getTypeLabel(entry.type)}</span>`;
                    entryDiv.appendChild(timeAndType);
                    
                    // Данные (разные для разных типов)
                    const dataDiv = document.createElement('div');
                    
                    if (entry.type === 'money') {
                        // Для денег отображаем итоговую сумму
                        const totalCopper = calculateTotalCopperFromHTML(entry.data);
                        const { gold, silver, copper } = convertCopperToCoins(totalCopper);
                        
                        dataDiv.innerHTML = `${gold} <img src="images/gold_coin.png" class="coin" alt="золото">, ${silver} <img src="images/silver_coin.png" class="coin" alt="серебро">, ${copper} <img src="images/copper_coin.png" class="coin" alt="медь">`;
                        
                    } else {
                        // Для нападений и предметов отображаем общее количество
                        const totalCount = Object.values(entry.data).reduce((sum, count) => sum + count, 0);
                        dataDiv.textContent = `Всего: ${totalCount}`;
                        
                        // Кнопка для показа подробностей
                        const detailsButton = document.createElement('button');
                        detailsButton.textContent = 'Подробности';
                        detailsButton.className = 'spoiler-button';
                        detailsButton.style.marginLeft = '10px';
                        detailsButton.onclick = function() {
                            const detailsDiv = this.nextElementSibling;
                            detailsDiv.style.display = detailsDiv.style.display === 'none' || detailsDiv.style.display === '' ? 'block' : 'none';
                        };
                        dataDiv.appendChild(detailsButton);
                        
                        // Создаем скрытый div для подробностей
                        const detailsDiv = document.createElement('div');
                        detailsDiv.style.display = 'none';
                        detailsDiv.style.marginTop = '10px';
                        
                        const detailsList = document.createElement('ul');
                        for (const [key, value] of Object.entries(entry.data)) {
                            const li = document.createElement('li');
                            if (entry.type === 'attacks' || entry.type === 'items') {
                                const img = document.createElement('img');
                                img.src = `images/${key}.gif`;
                                img.alt = key;
                                img.className = 'item-image';
                                img.style.width = '50px';
                                img.style.height = '50px';
                                img.onerror = () => { img.style.display = 'none'; };
                                li.appendChild(img);
                            }
                            li.innerHTML += `${key}: ${value}`;
                            detailsList.appendChild(li);
                        }
                        detailsDiv.appendChild(detailsList);
                        dataDiv.appendChild(detailsDiv);
                    }
                    
                    entryDiv.appendChild(dataDiv);
                    entriesDiv.appendChild(entryDiv);
                });
                
                historyDay.appendChild(entriesDiv);
                historyContainer.appendChild(historyDay);
            }
        }
        
        // Функция для получения метки типа записи
        function getTypeLabel(type) {
            switch(type) {
                case 'attacks': return 'Нападения';
                case 'money': return 'Деньги';
                case 'items': return 'Предметы';
                default: return type;
            }
        }
        
        // Функция для загрузки истории при загрузке страницы
        function loadHistory() {
            displayHistory();
        }
        
        // Функция для очистки истории
        function clearHistory() {
            localStorage.removeItem('log-history');
            displayHistory();
        }
        
        // Функция обработки двойного щелчка на записи истории
        function handleHistoryEntryDblClick(event) {
            // Ищем ближайший родительский элемент с классом history-entry
            const historyEntry = event.target.closest('.history-entry');
            if (!historyEntry) return;
            
            // Запрашиваем подтверждение у пользователя
            if (confirm('Удалить эту запись из истории?')) {
                // Находим индекс записи
                const allEntries = document.querySelectorAll('.history-entry');
                const index = Array.from(allEntries).indexOf(historyEntry);
                
                if (index !== -1) {
                    // Загружаем историю
                    let history = JSON.parse(localStorage.getItem('log-history') || '[]');
                    
                    // Определяем, к какой дате относится запись
                    const dateContainer = historyEntry.closest('.history-entries');
                    const dateEntries = dateContainer.querySelectorAll('.history-entry');
                    const entryIndexInDate = Array.from(dateEntries).indexOf(historyEntry);
                    
                    // Находим дату
                    const dateHeader = dateContainer.previousElementSibling;
                    const dateText = dateHeader.textContent.split(' (')[0];
                    
                    // Фильтруем записи по дате и находим нужную
                    const entriesForDate = history.filter(entry => {
                        return new Date(entry.date).toLocaleDateString() === dateText;
                    });
                    
                    if (entriesForDate.length > entryIndexInDate) {
                        // Находим запись в общем массиве
                        const entryToRemove = entriesForDate[entryIndexInDate];
                        const indexInFullHistory = history.findIndex(entry => entry.date === entryToRemove.date);
                        
                        if (indexInFullHistory !== -1) {
                            // Удаляем запись
                            history.splice(indexInFullHistory, 1);
                            localStorage.setItem('log-history', JSON.stringify(history));
                            
                            // Обновляем отображение
                            displayHistory();
                        }
                    }
                }
            }
        }
        
        // Функция для загрузки статистики
        function loadStats() {
            displayMonstersStats();
            displayMoneyStats();
            displayItemsStats(); // Обновлено для отображения частоты выпадения предметов
        }
        
        // Функция для отображения статистики по монстрам
        function displayMonstersStats() {
            const statsContainer = document.getElementById('total-monsters-stats');
            const totalStats = getTotalMonstersStats();
            
            if (Object.keys(totalStats).length === 0) {
                statsContainer.innerHTML = '<p>Нет данных о монстрах</p>';
                return;
            }
            
            // Сортируем монстров по количеству убийств (по убыванию)
            const sortedMonsters = Object.entries(totalStats).sort((a, b) => b[1] - a[1]);
            
            let html = '<table class="stats-table">';
            html += '<tr><th>Монстр</th><th>Количество</th></tr>';
            
            for (const [monster, count] of sortedMonsters) {
                html += `<tr>
                    <td>
                        <img src="images/${monster}.gif" class="item-image" style="width: 30px; height: 30px;" onerror="this.style.display='none'">
                        ${monster}
                    </td>
                    <td>${count}</td>
                </tr>`;
            }
            
            html += '</table>';
            
            // Добавляем общее количество
            const totalCount = sortedMonsters.reduce((sum, [_, count]) => sum + count, 0);
            html += `<p><strong>Всего монстров убито:</strong> ${totalCount}</p>`;
            
            statsContainer.innerHTML = html;
        }
        
        // Функция для получения общей статистики по монстрам
        function getTotalMonstersStats() {
            // Получаем все записи истории
            const history = JSON.parse(localStorage.getItem('log-history') || '[]');
            
            // Фильтруем только записи типа 'attacks'
            const attackEntries = history.filter(entry => entry.type === 'attacks');
            
            // Создаем общую статистику
            const totalStats = {};
            
            // Суммируем все результаты
            attackEntries.forEach(entry => {
                for (const [monster, count] of Object.entries(entry.data)) {
                    totalStats[monster] = (totalStats[monster] || 0) + count;
                }
            });
            
            return totalStats;
        }
        
        // Функция для отображения статистики по деньгам
        function displayMoneyStats() {
            const statsContainer = document.getElementById('total-money-stats');
            const totalCopper = getTotalMoneyStats();
            
            if (totalCopper === 0) {
                statsContainer.innerHTML = '<p>Нет данных о деньгах</p>';
                return;
            }
            
            // Преобразуем медь в золото, серебро и медь
            const gold = Math.floor(totalCopper / 10000);
            const remainder = totalCopper % 10000;
            const silver = Math.floor(remainder / 100);
            const copper = remainder % 100;
            
            let html = `<p><strong>Всего заработано:</strong></p>`;
            html += `<div class="money-stats">
                ${gold} <img src="images/gold_coin.png" class="coin" alt="золото">, 
                ${silver} <img src="images/silver_coin.png" class="coin" alt="серебро">, 
                ${copper} <img src="images/copper_coin.png" class="coin" alt="медь">
            </div>`;
            
            statsContainer.innerHTML = html;
        }
        
        // Функция для получения общей статистики по деньгам
        function getTotalMoneyStats() {
            // Получаем все записи истории
            const history = JSON.parse(localStorage.getItem('log-history') || '[]');
            
            // Фильтруем только записи типа 'money'
            const moneyEntries = history.filter(entry => entry.type === 'money');
            
            // Суммируем все результаты
            let totalCopper = 0;
            
            moneyEntries.forEach(entry => {
                totalCopper += calculateTotalCopperFromHTML(entry.data);
            });
            
            return totalCopper;
        }
        
        // Вспомогательная функция для расчета общего количества меди из HTML-строки
        function calculateTotalCopperFromHTML(htmlString) {
            // Ищем строку с итогом (которая содержит "Итого: X золото, Y серебро, Z медь")
            const totalMatch = htmlString.match(/Итого: (\d+) .+?, (\d+) .+?, (\d+)/);
            if (!totalMatch) return 0;
            
            const gold = parseInt(totalMatch[1]);
            const silver = parseInt(totalMatch[2]);
            const copper = parseInt(totalMatch[3]);
            
            return gold * 10000 + silver * 100 + copper;
        }
        
        // Функция для преобразования меди в золото, серебро и медь
        function convertCopperToCoins(totalCopper) {
            const gold = Math.floor(totalCopper / 10000);
            const remainder = totalCopper % 10000;
            const silver = Math.floor(remainder / 100);
            const copper = remainder % 100;
            
            return { gold, silver, copper };
        }
        
        // Функция для отображения статистики по предметам
        function displayItemsStats() {
            const statsContainer = document.getElementById('total-items-stats');
            const totalStats = getTotalItemsStats();
            
            if (Object.keys(totalStats).length === 0) {
                statsContainer.innerHTML = '<p>Нет данных о предметах</p>';
                return;
            }
            
            // Сортируем предметы по количеству (по убыванию)
            const sortedItems = Object.entries(totalStats).sort((a, b) => b[1] - a[1]);
            
            let html = '<table class="stats-table">';
            html += '<tr><th>Предмет</th><th>Количество</th></tr>';
            
            for (const [item, count] of sortedItems) {
                html += `<tr>
                    <td>
                        <img src="images/${item}.gif" class="item-image" style="width: 30px; height: 30px;" onerror="this.style.display='none'">
                        ${item}
                    </td>
                    <td>${count}</td>
                </tr>`;
            }
            
            html += '</table>';
            
            // Добавляем общее количество
            const totalCount = sortedItems.reduce((sum, [_, count]) => sum + count, 0);
            html += `<p><strong>Всего предметов найдено:</strong> ${totalCount}</p>`;
            
            statsContainer.innerHTML = html;
        }
        
        // Функция для получения общей статистики по предметам
        function getTotalItemsStats() {
            // Получаем все записи истории
            const history = JSON.parse(localStorage.getItem('log-history') || '[]');
            
            // Фильтруем только записи типа 'items'
            const itemEntries = history.filter(entry => entry.type === 'items');
            
            // Создаем общую статистику
            const totalStats = {};
            
            // Суммируем все результаты
            itemEntries.forEach(entry => {
                for (const [item, count] of Object.entries(entry.data)) {
                    totalStats[item] = (totalStats[item] || 0) + count;
                }
            });
            
            return totalStats;
        }
        
        // ФУНКЦИИ ДЛЯ РАБОТЫ С ХЛАМОМ
        
        // Функция для генерации уникального идентификатора
        function generateId() {
            return Date.now().toString(36) + Math.random().toString(36).substring(2);
        }
        
        // Добавление нового предмета хлама
        function addJunkItem() {
            const nameInput = document.getElementById('junkItemName');
            const goldInput = document.getElementById('junkGoldValue');
            const silverInput = document.getElementById('junkSilverValue');
            const copperInput = document.getElementById('junkCopperValue');
            
            const name = nameInput.value.trim();
            const gold = parseInt(goldInput.value) || 0;
            const silver = parseInt(silverInput.value) || 0;
            const copper = parseInt(copperInput.value) || 0;
            
            if (name === '') {
                alert('Пожалуйста, введите название предмета хлама.');
                return;
            }
            
            // Создаем новый предмет хлама
            const junkItem = {
                id: generateId(),
                name: name,
                goldValue: gold,
                silverValue: silver,
                copperValue: copper
            };
            
            // Сохраняем в localStorage
            saveJunkItem(junkItem);
            
            // Обновляем отображение
            displayJunkItem(junkItem);
            
            // Очищаем поля ввода
            nameInput.value = '';
            goldInput.value = '0';
            silverInput.value = '0';
            copperInput.value = '0';
            
            // Добавляем запись в историю
            const totalCopper = gold * 10000 + silver * 100 + copper;
            const formattedValue = formatMoneyResult(totalCopper, 'Стоимость');
            addHistoryEntry('junk', `Добавлен предмет хлама: ${name}, ${formattedValue}`);
        }
        
        // Загрузка предметов хлама из localStorage
        function loadJunkItems() {
            try {
                const junkItems = JSON.parse(localStorage.getItem('junkItems')) || [];
                const junkItemsContainer = document.getElementById('junkItems');
                junkItemsContainer.innerHTML = '';
                
                                junkItems.forEach(item => {
                    displayJunkItem(item);
                });
            } catch (error) {
                console.error('Ошибка при загрузке предметов хлама:', error);
                localStorage.removeItem('junkItems');
            }
        }
        
        // Отображение предмета хлама в списке
        function displayJunkItem(item) {
            const junkItemsContainer = document.getElementById('junkItems');
            
            const itemDiv = document.createElement('div');
            itemDiv.className = 'junk-item';
            itemDiv.dataset.id = item.id;
            
            const totalCopper = item.goldValue * 10000 + item.silverValue * 100 + item.copperValue;
            
            itemDiv.innerHTML = `
                <div class="junk-item-name">${item.name}</div>
                <div class="junk-item-value">
                    ${item.goldValue} <img src="images/gold_coin.png" class="coin" alt="золото">, 
                    ${item.silverValue} <img src="images/silver_coin.png" class="coin" alt="серебро">, 
                    ${item.copperValue} <img src="images/copper_coin.png" class="coin" alt="медь">
                </div>
                <button class="delete-junk" onclick="deleteJunkItem('${item.id}')">Удалить</button>
            `;
            
            junkItemsContainer.appendChild(itemDiv);
        }
        
        // Сохранение предмета хлама в localStorage
        function saveJunkItem(item) {
            const junkItems = JSON.parse(localStorage.getItem('junkItems')) || [];
            junkItems.push(item);
            localStorage.setItem('junkItems', JSON.stringify(junkItems));
        }
        
        // Удаление предмета хлама
        function deleteJunkItem(id) {
            // Получаем список предметов хлама
            const junkItems = JSON.parse(localStorage.getItem('junkItems')) || [];
            
            // Находим индекс удаляемого предмета
            const index = junkItems.findIndex(item => item.id === id);
            
            if (index !== -1) {
                // Сохраняем информацию о предмете для истории
                const deletedItem = junkItems[index];
                
                // Удаляем предмет из массива
                junkItems.splice(index, 1);
                
                // Сохраняем обновленный массив
                localStorage.setItem('junkItems', JSON.stringify(junkItems));
                
                // Удаляем элемент из DOM
                const itemElement = document.querySelector(`.junk-item[data-id="${id}"]`);
                if (itemElement) {
                    itemElement.remove();
                }
                
                // Добавляем запись в историю
                const totalCopper = deletedItem.goldValue * 10000 + deletedItem.silverValue * 100 + deletedItem.copperValue;
                const formattedValue = formatMoneyResult(totalCopper, 'Стоимость');
                addHistoryEntry('junk', `Удален предмет хлама: ${deletedItem.name}, ${formattedValue}`);
            }
        }
        
        // Очистка всех предметов хлама
        function clearJunkItems() {
            if (confirm('Вы уверены, что хотите удалить все предметы хлама?')) {
                localStorage.removeItem('junkItems');
                document.getElementById('junkItems').innerHTML = '';
                addHistoryEntry('junk', 'Все предметы хлама удалены');
            }
        }
        
        // Функция для подсчета предметов хлама из лога
        function countJunkItems() {
            const logInput = document.getElementById('logInput').value;
            if (!logInput.trim()) {
                alert('Пожалуйста, введите лог во вкладке "Лог".');
                return;
            }
            
            // Разбиваем лог на строки
            const logLines = logInput.split('\n');
            const junkItems = JSON.parse(localStorage.getItem('junkItems')) || [];
            if (junkItems.length === 0) {
                alert('Добавьте предметы хлама для подсчета.');
                return;
            }
            
            const junkCounts = {};
            let totalCopper = 0;
            
            // Для каждого предмета хлама проверяем, сколько раз он встречается в логе
            junkItems.forEach(item => {
                const itemName = item.name.trim();
                if (!itemName) return;
                
                // Экранируем специальные символы в названии предмета
                const escapedItemName = itemName.replace(/[-\/\\^$*+?.()|[\]{}]/g, '\\$&');
                
                // Создаем регулярные выражения для поиска предмета в логе
                // Формат: "Вы получили: Предмет хлама X шт"
                const itemRegex1 = new RegExp(`Вы получили:\\s*${escapedItemName}\\s+(\\d+)\\s+шт`, 'gi');
                // Формат: "Получено: Предмет хлама X шт"
                const itemRegex2 = new RegExp(`Получено:\\s*${escapedItemName}\\s+(\\d+)\\s+шт`, 'gi');
                // Формат: "XX:XX Получено: Предмет хлама X шт"
                const itemRegex3 = new RegExp(`\\d+:\\d+\\s+Получено:\\s*${escapedItemName}\\s+(\\d+)\\s+шт`, 'gi');
                // Формат просто упоминание предмета в логе
                const itemRegex4 = new RegExp(`${escapedItemName}`, 'gi');
                // Формат "[предмет] X шт"
                const itemRegex5 = new RegExp(`${escapedItemName}\\s+(\\d+)\\s+шт`, 'gi');
                
                // Специальный формат для "Злое око"
                const itemRegex6 = new RegExp(`Злое\\s+око`, 'gi');
                
                let itemCount = 0;
                
                // Подсчитываем количество предметов в логе
                logLines.forEach(line => {
                    let match;
                    
                    // Проверяем первый формат
                    while ((match = itemRegex1.exec(line)) !== null) {
                        const count = parseInt(match[1]) || 1;
                        itemCount += count;
                    }
                    
                    // Проверяем второй формат
                    itemRegex2.lastIndex = 0; // Сбрасываем индекс поиска
                    while ((match = itemRegex2.exec(line)) !== null) {
                        const count = parseInt(match[1]) || 1;
                        itemCount += count;
                    }
                    
                    // Проверяем третий формат
                    itemRegex3.lastIndex = 0; // Сбрасываем индекс поиска
                    while ((match = itemRegex3.exec(line)) !== null) {
                        const count = parseInt(match[1]) || 1;
                        itemCount += count;
                    }
                    
                    // Если не нашли по форматам, проверяем просто упоминание предмета
                    if (itemCount === 0) {
                        itemRegex4.lastIndex = 0; // Сбрасываем индекс поиска
                        if (itemRegex4.test(line)) {
                            itemCount += 1;
                        }
                        
                        // Проверяем формат "[предмет] X шт"
                        itemRegex5.lastIndex = 0; // Сбрасываем индекс поиска
                        while ((match = itemRegex5.exec(line)) !== null) {
                            const count = parseInt(match[1]) || 1;
                            itemCount += count;
                        }
                        
                        // Проверяем специальное регулярное выражение для "Злое око"
                        if (item.name === "Злое око") {
                            itemRegex6.lastIndex = 0; // Сбрасываем индекс поиска
                            if (itemRegex6.test(line)) {
                                // Пытаемся найти формат "Злое око X шт"
                                const shtukaMatch = line.match(/Злое\s+око\s+(\d+)\s+шт/i);
                                if (shtukaMatch && shtukaMatch[1]) {
                                    const count = parseInt(shtukaMatch[1]) || 1;
                                    itemCount += count;
                                } else {
                                    // Если формат не "X шт", то просто +1
                                    itemCount += 1;
                                }
                            }
                        }
                    }
                });
                
                // Если предмет найден в логе, добавляем его стоимость к общей сумме
                if (itemCount > 0) {
                    const gold = parseInt(item.goldValue) || 0;
                    const silver = parseInt(item.silverValue) || 0;
                    const copper = parseInt(item.copperValue) || 0;
                    
                    // Правильно считаем стоимость, умножая каждую часть отдельно
                    totalCopper += (gold * 10000 + silver * 100 + copper) * itemCount; // золото в медь
                    
                    console.log(`Найден предмет хлама в логе: ${item.name} - ${itemCount} шт., стоимость: (${gold}з ${silver}с ${copper}м) за штуку, общая стоимость: ${gold * itemCount}з ${silver * itemCount}с ${copper * itemCount}м`);
                }
            });
            
            // Если ничего не найдено, выводим сообщение
            if (Object.keys(junkCounts).length === 0) {
                alert('Предметы хлама не найдены в логе.');
                return;
            }
            
            // Отображаем результаты
            const totalGold = Math.floor(totalCopper / 10000);
            const totalSilver = Math.floor((totalCopper % 10000) / 100);
            const totalCopperFinal = totalCopper % 100;

            const resultsHTML = `<h2>Результаты подсчета хлама:</h2>
                                 <div>Общая стоимость: ${totalGold} золота, ${totalSilver} серебра, ${totalCopperFinal} меди</div>`;
            document.getElementById('results').innerHTML = resultsHTML;
        }
        
        // Автоматическое добавление строк в лог для хлама при генерации результатов
        function generateJunkLogLines() {
            const junkItems = JSON.parse(localStorage.getItem('junkItems')) || [];
            if (junkItems.length === 0) return '';
            
            let logLines = '';
            
            junkItems.forEach(item => {
                const goldValue = item.goldValue || 0;
                const silverValue = item.silverValue || 0;
                const copperValue = item.copperValue || 0;
                
                if (goldValue > 0) {
                    logLines += `Хлам принес вам: ${goldValue}з ${silverValue}с ${copperValue}м\n`;
                } else {
                    logLines += `Хлам принес вам: ${silverValue}с ${copperValue}м\n`;
                }
            });
            
            return logLines;
        }
        
        // Функция для добавления стилей для хлама
        function addJunkStyles() {
            const style = document.createElement('style');
            style.textContent = `
                .junk-item {
                    display: flex;
                    justify-content: space-between;
                    align-items: center;
                    padding: 10px;
                    margin-bottom: 5px;
                    background-color: #f5f5f5;
                    border-radius: 5px;
                }
                .junk-item-name {
                    flex: 1;
                    font-weight: bold;
                }
                .junk-item-value {
                    flex: 1;
                    text-align: center;
                }
                .delete-junk {
                    background-color: #ff4d4d;
                    color: white;
                    border: none;
                    padding: 5px 10px;
                    border-radius: 3px;
                    cursor: pointer;
                }
                .delete-junk:hover {
                    background-color: #ff1a1a;
                }
                .money-input {
                    display: flex;
                    gap: 10px;
                    margin: 10px 0;
                }
                /* Стили для прогресс-баров */
                .progress-bar-container {
                    width: 100%;
                    height: 8px;
                    background-color: #e0e0e0;
                    border-radius: 4px;
                    margin-top: 5px;
                    overflow: hidden;
                }
                .progress-bar {
                    height: 100%;
                    background-color: #4CAF50;
                    border-radius: 4px;
                }
            `;
            document.head.appendChild(style);
        }
        
        // Вызываем функцию добавления стилей при загрузке страницы
        document.addEventListener('DOMContentLoaded', function() {
            addJunkStyles();
        });
    </script>
</body>
</html>
